<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>patient_desktop_client</title>

    <!-- WinJS references -->
    <link href="//Microsoft.WinJS.2.0/css/ui-dark.css" rel="stylesheet" />
    <script src="//Microsoft.WinJS.2.0/js/base.js"></script>
    <script src="//Microsoft.WinJS.2.0/js/ui.js"></script>

    <!-- patient_desktop_client references -->
    <link href="/css/default.css" rel="stylesheet" />
    <script src="/js/default.js"></script>
</head>
<body>
    
    <!-- Audio files -->
    <audio id="exercise_start">
        <source src="/audio/exercise_start.mp3" type="audio/mpeg">
    </audio>
    <audio id="exercise_done">
        <source src="/audio/exercise_done.mp3" type="audio/mpeg">
    </audio>
    <audio id="rep_done">
        <source src="/audio/rep_done.mp3" type="audio/mpeg">
    </audio>

    <!-- Textual information -->
    <h1 id="msg">Please fully extend your right arm to start exercise.</h1>

    <!-- ********************* Custom Shader Code ********************* -->
    <!--
        Author: Lee Stemkoski
        Taken from: http://stemkoski.github.io/Three.js/
    -->
    <script id="vertexShader" type="x-shader/x-vertex">
        uniform vec3 viewVector;
        uniform float c;
        uniform float p;
        varying float intensity;
        void main()
        {
        vec3 vNormal = normalize( normalMatrix * normal );
        vec3 vNormel = normalize( normalMatrix * viewVector );
        intensity = pow( c - dot(vNormal, vNormel), p );

        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        }
    </script>

    <script id="fragmentShader" type="x-shader/x-vertex">
        uniform vec3 glowColor;
        varying float intensity;
        void main()
        {
        vec3 glow = glowColor * intensity;
        gl_FragColor = vec4( glow, 1.0 );
        }
    </script>
    <!-- **************************************************************- -->

    <!-- Scripts to be executed after document loaded -->
    <script src="/js/three.min.js"></script>
    <script src="/js/OrbitControls.js"></script>

    <script src="/js/kinect/KinectDataExtractor.js"></script>
    <script src="/js/domain/BodyData.js"></script>
    <script src="/js/domain/Bone.js"></script>
    <script src="/js/domain/BoneType.js"></script>
    <script src="/js/domain/JointBoneMapper.js"></script>
    <script src="/js/domain/Exercise.js"></script>
    <script src="/js/scene/Scene.js"></script>
    <script src="/js/scene/Model.js"></script>
    
    <script>

        /* the SDK Kinect object */
        var kinect = WindowsPreview.Kinect;

        /* the Kinect sensor */
        var sensor = kinect.KinectSensor.getDefault();

        /* A reader object which reads body frames from the sensor */
        var bodyFrameReader = sensor.bodyFrameSource.openReader();
        bodyFrameReader.addEventListener("framearrived", readerBodyFrameArrived);

        /* an empty array that will store body objects read from the sensor */
        var bodies = new Array(sensor.bodyFrameSource.bodyCount);

        sensor.open();

        /* indicates wether the Kinect sensor is running */
        var running = false;

        /* an array for storing joints data
         * each joint is of type WindowsPreview.Kinect
         */
        var joints = null;

        /* TODO temp counter var */
        var frameNum = 0;

        /* called every time a new body frame is read from the sensor */
        function readerBodyFrameArrived(args) {

            // get bodies data from frame
            var bodyFrame = args.frameReference.acquireFrame();
            if (bodyFrame == null) {
                return;
            }
            bodyFrame.getAndRefreshBodyData(bodies);
            bodyFrame.close();

            // find a tracked body and store its joint positions
            for (i = 0; i < bodies.length; i++) {
                // find a tracked body and exit loop as soon as one is found
                if (bodies[i].isTracked) {
                    var kinectJoints = bodies[i].joints;
                    joints = new Array();
                    for (i = 0; i < kinectJoints.size; i++) {
                        var joint = kinectJoints.lookup(i);
                        joints.push(kinectJoints.lookup(i));
                        console.log(joint.position.x + " " + joint.position.y + " " + joint.position.z);
                    }
                    console.log("*****");
                    break;
                }
            }
        }

        new Scene().beginRendering();

    </script>
</body>
</html>
